# H∆∞·ªõng D·∫´n C√†i ƒê·∫∑t EJBCA CE 9.1.1 tr√™n Ubuntu 24.04

## üìã T·ªïng Quan

T√†i li·ªáu n√†y h∆∞·ªõng d·∫´n c√†i ƒë·∫∑t v√† c·∫•u h√¨nh EJBCA Community Edition 9.1.1 tr√™n Ubuntu 24.04 v·ªõi:
- **WildFly 32.0.0.Final** - Application Server
- **MariaDB 10.11.13** - Database
- **OpenJDK 21** - Java Runtime
- **Apache Ant 1.10.14** - Build Tool

---

## üîß B∆∞·ªõc 1: C√†i ƒê·∫∑t Dependencies

### 1.1. C√†i ƒë·∫∑t Java, Ant v√† Git
```bash
sudo apt update
sudo apt install -y openjdk-21-jdk ant git
```

### 1.2. C√†i ƒë·∫∑t MariaDB
```bash
sudo apt install -y mariadb-server mariadb-client
sudo systemctl start mariadb
sudo systemctl enable mariadb
```

### 1.3. T·∫°o Database v√† User
```bash
mysql -u root -e "CREATE DATABASE ejbca CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"
mysql -u root -e "CREATE USER 'ejbca'@'localhost' IDENTIFIED BY 'ejbca';"
mysql -u root -e "GRANT ALL PRIVILEGES ON ejbca.* TO 'ejbca'@'localhost';"
mysql -u root -e "FLUSH PRIVILEGES;"
```

---

## üöÄ B∆∞·ªõc 2: C√†i ƒê·∫∑t WildFly

### 2.1. Download v√† Gi·∫£i N√©n WildFly
```bash
cd /tmp
wget https://github.com/wildfly/wildfly/releases/download/32.0.0.Final/wildfly-32.0.0.Final.tar.gz
sudo tar -xzf wildfly-32.0.0.Final.tar.gz -C /opt/
sudo mv /opt/wildfly-32.0.0.Final /opt/wildfly
```

### 2.2. T·∫°o Th∆∞ M·ª•c C·∫ßn Thi·∫øt
```bash
sudo mkdir -p /opt/wildfly/standalone/{log,data,tmp}
sudo mkdir -p /opt/wildfly/standalone/configuration/keystore
sudo chown -R $USER:$USER /opt/wildfly
sudo chown -R $USER:$USER /opt/wildfly-32.0.0.Final
```

### 2.3. Set Bi·∫øn M√¥i Tr∆∞·ªùng
```bash
echo 'export APPSRV_HOME=/opt/wildfly' >> ~/.bashrc
source ~/.bashrc
```

---

## üíæ B∆∞·ªõc 3: Deploy MariaDB JDBC Driver

### 3.1. Download JDBC Driver
```bash
cd /tmp
wget https://dlm.mariadb.com/3906418/Connectors/java/connector-java-3.1.4/mariadb-java-client-3.1.4.jar
sudo cp mariadb-java-client-3.1.4.jar /opt/wildfly/standalone/deployments/
```

### 3.2. Kh·ªüi ƒê·ªông WildFly L·∫ßn ƒê·∫ßu
```bash
/opt/wildfly/bin/standalone.sh -b 0.0.0.0 > /dev/null 2>&1 &
sleep 20  # ƒê·ª£i WildFly kh·ªüi ƒë·ªông
```

---

## üîê B∆∞·ªõc 4: C·∫•u H√¨nh Datasource

### 4.1. T·∫°o Credential Store
```bash
/opt/wildfly/bin/jboss-cli.sh --connect << 'EOF'
/subsystem=elytron/credential-store=ejbcaCredStore:add(
    location=/opt/wildfly/standalone/configuration/ejbca-credentials.store,
    create=true,
    credential-reference={clear-text=storepassword}
)
/subsystem=elytron/credential-store=ejbcaCredStore:add-alias(
    alias=dbPassword,
    secret-value=ejbca
)
EOF
```

### 4.2. Th√™m Datasource
```bash
/opt/wildfly/bin/jboss-cli.sh --connect << 'EOF'
data-source add \
    --name=ejbcaDS \
    --jndi-name=java:/EjbcaDS \
    --driver-name=mariadb-java-client-3.1.4.jar \
    --connection-url=jdbc:mariadb://127.0.0.1:3306/ejbca \
    --user-name=ejbca \
    --credential-reference={store=ejbcaCredStore,alias=dbPassword} \
    --min-pool-size=5 \
    --max-pool-size=50 \
    --pool-prefill=true \
    --transaction-isolation=TRANSACTION_READ_COMMITTED \
    --enabled=true
EOF
```

### 4.3. Test Connection
```bash
/opt/wildfly/bin/jboss-cli.sh --connect \
    --command="/subsystem=datasources/data-source=ejbcaDS:test-connection-in-pool"
```

**K·∫øt qu·∫£ mong ƒë·ª£i:** `"outcome" => "success"`

---

## üì¶ B∆∞·ªõc 5: Build v√† Deploy EJBCA

### 5.1. Clone EJBCA Source Code
```bash
cd ~
git clone https://github.com/Keyfactor/ejbca-ce.git
cd ejbca-ce
sudo chown -R $USER:$USER .
```

### 5.2. C·∫•u H√¨nh Database
```bash
# Edit database.properties
sed -i 's/^#database.name=mysql/database.name=mysql/' ~/ejbca-ce/conf/database.properties
sed -i 's|^#database.url=.*|database.url=jdbc:mariadb://127.0.0.1:3306/ejbca|' ~/ejbca-ce/conf/database.properties
sed -i 's/^#database.driver=.*/database.driver=org.mariadb.jdbc.Driver/' ~/ejbca-ce/conf/database.properties
```

### 5.3. Build EJBCA
```bash
cd ~/ejbca-ce
ant clean build
```

**Th·ªùi gian:** ~40-45 gi√¢y

### 5.4. Deploy EJBCA
```bash
ant deployear
```

### 5.5. ƒê·ª£i Deployment Ho√†n T·∫•t
```bash
sleep 30
ls -lh /opt/wildfly/standalone/deployments/ejbca.ear*
```

**Ki·ªÉm tra:** File `ejbca.ear.deployed` ph·∫£i xu·∫•t hi·ªán

---

## üîß B∆∞·ªõc 6: C·∫•u H√¨nh EJB Client

### 6.1. Update Port cho EJB Remoting
```bash
sed -i 's/^remote.connection.default.port = 4447$/remote.connection.default.port = 8080/' \
    ~/ejbca-ce/dist/ejbca-ejb-cli/jboss-ejb-client.properties
```

**L√Ω do:** WildFly 32 s·ª≠ d·ª•ng HTTP remoting tr√™n port 8080 thay v√¨ port 4447

---

## üèóÔ∏è B∆∞·ªõc 7: Kh·ªüi T·∫°o EJBCA (runinstall)

### 7.1. Ch·∫°y Installation
```bash
cd ~/ejbca-ce
ant runinstall
```

**C√°c gi√° tr·ªã m·∫∑c ƒë·ªãnh:**
- CA name: `ManagementCA`
- CA DN: `CN=ManagementCA,O=EJBCA Sample,C=SE`
- Key type: `RSA`
- Key spec: `2048`
- Signature algorithm: `SHA256WithRSA`
- Validity: `3650` days (10 nƒÉm)
- CA token password: Nh·∫•n Enter (s·∫Ω t·ª± sinh)

**K·∫øt qu·∫£:**
- ‚úÖ Management CA ƒë∆∞·ª£c t·∫°o
- ‚úÖ Database schema ƒë∆∞·ª£c kh·ªüi t·∫°o (70+ tables)
- ‚úÖ Super Admin certificate: `~/ejbca-ce/p12/superadmin.p12`
- ‚úÖ Server certificate: `~/ejbca-ce/p12/tomcat.p12`
- ‚úÖ Truststore: `~/ejbca-ce/p12/truststore.p12`

---

## üîê B∆∞·ªõc 8: Deploy TLS Keystores

### 8.1. Deploy Keystores
```bash
cd ~/ejbca-ce
ant deploy-keystore
```

### 8.2. Restart WildFly
```bash
pkill -9 -f wildfly
sleep 3
/opt/wildfly/bin/standalone.sh -b 0.0.0.0 > /dev/null 2>&1 &
sleep 30  # ƒê·ª£i WildFly kh·ªüi ƒë·ªông
```

### 8.3. Verify Keystores
```bash
ls -lh /opt/wildfly/standalone/configuration/keystore/
```

**Ph·∫£i c√≥ 2 files:**
- `keystore.p12` - Server TLS certificate
- `truststore.p12` - CA certificates

---

## üîê B∆∞·ªõc 8.4: C·∫•u H√¨nh SSL Client Authentication

**QUAN TR·ªåNG:** ƒê·ªÉ Admin Web y√™u c·∫ßu client certificate, c·∫ßn c·∫•u h√¨nh WildFly SSL context.

### 8.4.1. T·∫°o CLI Script
```bash
cat << 'EOF' > /tmp/configure-ssl.cli
# Create trust-manager using the truststore
/subsystem=elytron/key-store=trustKS:add(path=keystore/truststore.p12,relative-to=jboss.server.config.dir,credential-reference={clear-text=changeit},type=PKCS12)
/subsystem=elytron/trust-manager=trustManager:add(key-store=trustKS)

# Update server-ssl-context to require client authentication
/subsystem=elytron/server-ssl-context=applicationSSC:write-attribute(name=need-client-auth,value=true)
/subsystem=elytron/server-ssl-context=applicationSSC:write-attribute(name=trust-manager,value=trustManager)

# Reload server
:reload
EOF
```

### 8.4.2. Ch·∫°y CLI Script
```bash
/opt/wildfly/bin/jboss-cli.sh --connect --file=/tmp/configure-ssl.cli
```

**K·∫øt qu·∫£ mong ƒë·ª£i:**
```
{"outcome" => "success"}
{"outcome" => "success"}
{"outcome" => "success", ...}
{"outcome" => "success", ...}
{"outcome" => "success"}
```

### 8.4.3. ƒê·ª£i WildFly Reload
```bash
sleep 20
```

### 8.4.4. Verify SSL Configuration
```bash
# Test WITHOUT certificate (should fail)
curl -k -s -o /dev/null -w "Without cert: %{http_code}\n" https://localhost:8443/ejbca/adminweb/

# Test WITH certificate (should succeed)
curl --cert ~/Documents/superadmin.p12:ejbca --cert-type P12 -k -s -o /dev/null -w "With cert: %{http_code}\n" https://localhost:8443/ejbca/adminweb/
```

**K·∫øt qu·∫£ mong ƒë·ª£i:**
```
Without cert: 000  (SSL handshake failed - GOOD!)
With cert: 200     (Access granted - GOOD!)
```

### 8.4.5. Verify CLI Configuration
```bash
/opt/wildfly/bin/jboss-cli.sh --connect --command="/subsystem=elytron/server-ssl-context=applicationSSC:read-resource()" | grep -E "(need-client-auth|trust-manager)"
```

**K·∫øt qu·∫£ mong ƒë·ª£i:**
```
"need-client-auth" => true,
"trust-manager" => "trustManager",
```

---

## üéâ B∆∞·ªõc 9: Truy C·∫≠p EJBCA

### 9.1. Copy Super Admin Certificate
```bash
cp ~/ejbca-ce/p12/superadmin.p12 ~/Documents/
```

### 9.2. Import Certificate v√†o Browser

#### **Firefox:**
1. M·ªü `Settings` ‚Üí `Privacy & Security`
2. Cu·ªôn xu·ªëng `Certificates` ‚Üí Click `View Certificates`
3. Tab `Your Certificates` ‚Üí Click `Import`
4. Ch·ªçn file `~/Documents/superadmin.p12`
5. Nh·∫≠p password: **`ejbca`**
6. Click **OK**

#### **Chrome/Chromium:**
1. M·ªü `Settings` ‚Üí `Privacy and Security` ‚Üí `Security`
2. Cu·ªôn xu·ªëng `Manage certificates`
3. Tab `Your certificates` ‚Üí Click `Import`
4. Ch·ªçn file `~/Documents/superadmin.p12`
5. Nh·∫≠p password: **`ejbca`**
6. Click **OK**

**‚ö†Ô∏è QUAN TR·ªåNG:** Sau khi import certificate, **ƒë√≥ng HO√ÄN TO√ÄN browser** (kh√¥ng ch·ªâ ƒë√≥ng tab) v√† m·ªü l·∫°i.

### 9.3. Truy C·∫≠p Admin Web

1. M·ªü browser v√† truy c·∫≠p: **https://localhost:8443/ejbca/adminweb/**
2. Browser s·∫Ω hi·ªÉn th·ªã **Certificate Warning** (do self-signed):
   - Firefox: Click **"Advanced"** ‚Üí **"Accept the Risk and Continue"**
   - Chrome: Click **"Advanced"** ‚Üí **"Proceed to localhost (unsafe)"**
3. Browser s·∫Ω hi·ªÉn th·ªã **"User Identification Request"** (ch·ªçn certificate):
   - Ch·ªçn certificate **`SuperAdmin`** ho·∫∑c **`CN=SuperAdmin`**
   - Click **OK** ho·∫∑c **Allow**
4. B·∫°n s·∫Ω th·∫•y EJBCA Admin Web interface

**N·∫øu kh√¥ng th·∫•y prompt ch·ªçn certificate:**
- ƒê·∫£m b·∫£o ƒë√£ ƒë√≥ng ho√†n to√†n browser v√† m·ªü l·∫°i
- Ki·ªÉm tra certificate ƒë√£ import: Settings ‚Üí Certificates ‚Üí Your Certificates
- X√≥a certificate c≈© n·∫øu c√≥ v√† import l·∫°i

### 9.4. T·ªïng H·ª£p C√°c URLs

| Interface | URL | Y√™u C·∫ßu |
|-----------|-----|---------|
| **RA Web** | http://localhost:8080/ejbca/ra/ | Kh√¥ng c·∫ßn cert |
| **Admin Web** | https://localhost:8443/ejbca/adminweb/ | C·∫ßn superadmin.p12 |
| **REST API** | http://localhost:8080/ejbca/ejbca-rest-api/ | T√πy API |
| **Public Web** | http://localhost:8080/ejbca/ | Kh√¥ng c·∫ßn cert |

---

## üîç Ki·ªÉm Tra v√† X√°c Minh

### Ki·ªÉm tra WildFly
```bash
ps aux | grep wildfly | grep -v grep
```

### Ki·ªÉm tra Database Tables
```bash
mysql -u ejbca -pejbca ejbca -e "SHOW TABLES;" | wc -l
```
**K·∫øt qu·∫£:** Ph·∫£i c√≥ 70+ tables

### Ki·ªÉm tra HTTP/HTTPS
```bash
# Test HTTP
curl -s http://localhost:8080/ejbca/ra/ -o /dev/null -w "HTTP: %{http_code}\n"

# Test HTTPS
curl -k -s https://localhost:8443/ejbca/adminweb/ -o /dev/null -w "HTTPS: %{http_code}\n"
```
**K·∫øt qu·∫£ mong ƒë·ª£i:** C·∫£ 2 ƒë·ªÅu tr·∫£ v·ªÅ `200`

### Ki·ªÉm tra Datasource
```bash
/opt/wildfly/bin/jboss-cli.sh --connect \
    --command="/subsystem=datasources/data-source=ejbcaDS:test-connection-in-pool"
```

---

## üõ†Ô∏è Qu·∫£n L√Ω v√† V·∫≠n H√†nh

### Kh·ªüi ƒê·ªông WildFly
```bash
/opt/wildfly/bin/standalone.sh -b 0.0.0.0 > /dev/null 2>&1 &
```

### D·ª´ng WildFly
```bash
pkill -9 -f wildfly
```

### Xem Log
```bash
tail -f /opt/wildfly/standalone/log/server.log
```

### S·ª≠ D·ª•ng EJBCA CLI
```bash
cd ~/ejbca-ce/dist/ejbca-ejb-cli
java -jar ejbca-ejb-cli.jar ca listcas
java -jar ejbca-ejb-cli.jar ca info ManagementCA
```

---

## üîÑ Reset v√† C√†i ƒê·∫∑t L·∫°i

### Reset Ho√†n To√†n
```bash
# 1. D·ª´ng WildFly
pkill -9 -f wildfly

# 2. X√≥a Database
mysql -u ejbca -pejbca -e "DROP DATABASE IF EXISTS ejbca; CREATE DATABASE ejbca CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"

# 3. X√≥a Certificates
rm -rf ~/ejbca-ce/p12/*
rm -f ~/Documents/superadmin.p12

# 4. X√≥a Deployment
rm -f /opt/wildfly/standalone/deployments/ejbca.ear*

# 5. Kh·ªüi ƒë·ªông l·∫°i WildFly
/opt/wildfly/bin/standalone.sh -b 0.0.0.0 > /dev/null 2>&1 &
sleep 30

# 6. Deploy l·∫°i
cd ~/ejbca-ce
ant deployear
sleep 30

# 7. Ch·∫°y install
ant runinstall

# 8. Deploy keystores
ant deploy-keystore

# 9. Restart WildFly
pkill -9 -f wildfly
sleep 3
/opt/wildfly/bin/standalone.sh -b 0.0.0.0 > /dev/null 2>&1 &
sleep 30

# 10. Configure SSL Client Authentication
/opt/wildfly/bin/jboss-cli.sh --connect --file=/tmp/configure-ssl.cli
sleep 20

# 11. Copy certificate
cp ~/ejbca-ce/p12/superadmin.p12 ~/Documents/
```

---

## üìù Th√¥ng Tin Quan Tr·ªçng

### Credentials
| Th√†nh ph·∫ßn | Username | Password |
|-----------|----------|----------|
| MariaDB | `ejbca` | `ejbca` |
| Super Admin P12 | - | `ejbca` |
| Credential Store | - | `storepassword` |

### Ports
| Service | Port | Protocol |
|---------|------|----------|
| HTTP | 8080 | HTTP |
| HTTPS | 8443 | HTTPS |
| Management | 9990 | HTTP |

### ƒê∆∞·ªùng D·∫´n Files
| File/Directory | Path |
|----------------|------|
| WildFly Home | `/opt/wildfly` |
| EJBCA Source | `~/ejbca-ce` |
| Keystores | `/opt/wildfly/standalone/configuration/keystore/` |
| Certificates | `~/ejbca-ce/p12/` |
| Super Admin Cert | `~/Documents/superadmin.p12` |
| Server Log | `/opt/wildfly/standalone/log/server.log` |

### Database Schema
- **Total Tables:** 70+
- **Key Tables:**
  - `CAData` - CA information
  - `CertificateData` - Issued certificates
  - `UserData` - End entities
  - `AccessRulesData` - Authorization rules
  - `AdminGroupData` - Admin groups
  - `AuditRecordData` - Audit logs

---

## ‚ö†Ô∏è Troubleshooting

### WildFly kh√¥ng kh·ªüi ƒë·ªông
```bash
# Ki·ªÉm tra log
tail -50 /opt/wildfly/standalone/log/server.log

# Ki·ªÉm tra port ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng ch∆∞a
ss -tlnp | grep -E ":(8080|8443|9990)"
```

### EJBCA CLI kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c
```bash
# Ki·ªÉm tra port 8080 c√≥ listening kh√¥ng
ss -tlnp | grep 8080

# Verify EJB client config
cat ~/ejbca-ce/dist/ejbca-ejb-cli/jboss-ejb-client.properties
# Port ph·∫£i l√† 8080, kh√¥ng ph·∫£i 4447
```

### Datasource connection failed
```bash
# Test connection
/opt/wildfly/bin/jboss-cli.sh --connect \
    --command="/subsystem=datasources/data-source=ejbcaDS:test-connection-in-pool"

# Ki·ªÉm tra MariaDB
sudo systemctl status mariadb
mysql -u ejbca -pejbca ejbca -e "SELECT 1;"
```

### HTTPS kh√¥ng ho·∫°t ƒë·ªông
```bash
# Ki·ªÉm tra keystores ƒë√£ deploy ch∆∞a
ls -lh /opt/wildfly/standalone/configuration/keystore/

# N·∫øu ch∆∞a c√≥, deploy l·∫°i
cd ~/ejbca-ce
ant deploy-keystore

# Restart WildFly
pkill -9 -f wildfly
/opt/wildfly/bin/standalone.sh -b 0.0.0.0 > /dev/null 2>&1 &
```

### Browser kh√¥ng hi·ªÉn th·ªã prompt ch·ªçn certificate

**Tri·ªáu ch·ª©ng:** Khi truy c·∫≠p Admin Web, kh√¥ng th·∫•y dialog y√™u c·∫ßu ch·ªçn certificate, ch·ªâ th·∫•y l·ªói "Authorization Denied - No client certificate was presented"

**Nguy√™n nh√¢n:** WildFly ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh ƒë·ªÉ y√™u c·∫ßu client certificate (need-client-auth)

**Gi·∫£i ph√°p:**

1. **Ki·ªÉm tra c·∫•u h√¨nh SSL hi·ªán t·∫°i:**
```bash
/opt/wildfly/bin/jboss-cli.sh --connect \
  --command="/subsystem=elytron/server-ssl-context=applicationSSC:read-resource()" \
  | grep need-client-auth
```

N·∫øu k·∫øt qu·∫£ l√† `"need-client-auth" => false` ho·∫∑c `undefined`, c·∫ßn c·∫•u h√¨nh l·∫°i.

2. **C·∫•u h√¨nh SSL Client Authentication:**
```bash
# T·∫°o CLI script
cat << 'EOF' > /tmp/configure-ssl.cli
/subsystem=elytron/key-store=trustKS:add(path=keystore/truststore.p12,relative-to=jboss.server.config.dir,credential-reference={clear-text=changeit},type=PKCS12)
/subsystem=elytron/trust-manager=trustManager:add(key-store=trustKS)
/subsystem=elytron/server-ssl-context=applicationSSC:write-attribute(name=need-client-auth,value=true)
/subsystem=elytron/server-ssl-context=applicationSSC:write-attribute(name=trust-manager,value=trustManager)
:reload
EOF

# Ch·∫°y CLI script
/opt/wildfly/bin/jboss-cli.sh --connect --file=/tmp/configure-ssl.cli

# ƒê·ª£i reload
sleep 20
```

3. **Verify c·∫•u h√¨nh:**
```bash
# Test WITHOUT certificate (should fail with SSL error)
curl -k -s -o /dev/null -w "Without cert: %{http_code}\n" https://localhost:8443/ejbca/adminweb/

# Test WITH certificate (should return 200)
curl --cert ~/Documents/superadmin.p12:ejbca --cert-type P12 -k -s -o /dev/null -w "With cert: %{http_code}\n" https://localhost:8443/ejbca/adminweb/
```

K·∫øt qu·∫£ mong ƒë·ª£i:
- Without cert: `000` (SSL handshake failed)
- With cert: `200` (Success)

4. **Trong browser:**
   - ƒê√≥ng HO√ÄN TO√ÄN browser (t·∫•t c·∫£ c·ª≠a s·ªï)
   - M·ªü l·∫°i v√† truy c·∫≠p https://localhost:8443/ejbca/adminweb/
   - Gi·ªù browser s·∫Ω hi·ªÉn th·ªã prompt ch·ªçn certificate

### Certificate kh√¥ng ƒë∆∞·ª£c trust trong browser

**Tri·ªáu ch·ª©ng:** Browser hi·ªÉn th·ªã l·ªói SSL/TLS v·ªÅ certificate kh√¥ng tin c·∫≠y

**Gi·∫£i ph√°p:**

# N·∫øu ch∆∞a c√≥, deploy l·∫°i
cd ~/ejbca-ce
ant deploy-keystore

# Restart WildFly
pkill -9 -f wildfly
/opt/wildfly/bin/standalone.sh -b 0.0.0.0 > /dev/null 2>&1 &
```

---